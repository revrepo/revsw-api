"use strict";

var _       = require('lodash');
var Winston = require('winston');
var MongoDB = require('winston-mongodb').MongoDB;
var Schema  = require('./schema');
var Joi     = require('joi');


function Logger () {}

/**
 * @param object
 */
Logger.init = function (object) {
	var mongodbRequiredKeys = ['db', 'collection', 'host', 'port'];
	var fileRequiredKeys    = ['filename', 'stream', 'timestamp'];

	if (
			!_.has(object, 'mongodb') ||
			!_.has(object, 'file') ||
			!_.every(mongodbRequiredKeys, _.partial(_.has, object.mongodb)) ||
			!_.every(fileRequiredKeys,    _.partial(_.has, object.file))
	) {
		console.log('Incorrect configuration. Please see README.md');
		return false;
	}

	Logger.addTransport(object);
}

Logger._addTransport = function (object) {
	Winston.add(MongoDB, {
		db         : 'mongodb://'+object.mongodb.host+':'+object.mongodb.port+'/'+object.mongodb.db,
		collection : object.mongodb.collection
	});
	Winston.add(Winston.transports.File, {
		timestamp : true,
		filename  : 'audit.log',
	});
}

Logger.store = function (object) {
	object = object || false;
	Joi.assert(object, Schema.options);
	Winston.info(object);
}

module.exports = Logger;